package com.pedigree.render;

import com.pedigree.layout.LayoutResult;
import com.pedigree.model.Family;
import com.pedigree.model.Individual;
import com.pedigree.model.Relationship;
// ... existing code ...
import com.pedigree.storage.ProjectRepository;

import java.awt.geom.Point2D;
import java.util.HashSet;
import java.util.Set;
// ... existing code ...
import java.util.HashMap;
import java.util.Map;

public class TreeRenderer {

// ... existing code ...
    public void render(ProjectRepository.ProjectData data, LayoutResult layout, GraphicsContext g,
                       double zoom, double panX, double panY) {
        if (data == null || layout == null || g == null) return;

        // Build id sets to differentiate individuals and families
        Set<String> individualIds = new HashSet<>();
        for (Individual i : data.individuals) individualIds.add(i.getId());
        Set<String> familyIds = new HashSet<>();
        for (Family f : data.families) familyIds.add(f.getId());

        // Map for quick lookup of Individuals by id (to access gender)
        Map<String, Individual> individualsById = new HashMap<>();
        for (Individual i : data.individuals) {
            individualsById.put(i.getId(), i);
        }

        // Draw nodes
        g.setLineWidth(1.5);
        for (String id : layout.getNodeIds()) {
            Point2D p = layout.getPosition(id);
            if (p == null) continue;
            double w = metrics.getWidth(id) * zoom;
            double h = metrics.getHeight(id) * zoom;
            double x = p.getX() * zoom + panX;
            double y = p.getY() * zoom + panY;

            if (individualIds.contains(id)) {
                Individual ind = individualsById.get(id);
                // Softer palette; avoid bright yellow for female
                if (ind != null && ind.getGender() == com.pedigree.model.Gender.FEMALE) {
                    // Soft lavender: rgb(242, 234, 255)
                    g.setFillColor(242, 234, 255, 1.0);
                    g.setStrokeColor(90, 70, 120, 1.0);
                } else if (ind != null && ind.getGender() == com.pedigree.model.Gender.MALE) {
                    // Soft blue: rgb(230, 240, 255)
                    g.setFillColor(230, 240, 255, 1.0);
                    g.setStrokeColor(50, 70, 110, 1.0);
                } else {
                    // Unknown/other: neutral light gray-blue
                    g.setFillColor(235, 240, 245, 1.0);
                    g.setStrokeColor(70, 80, 90, 1.0);
                }
            } else if (familyIds.contains(id)) {
                g.setFillColor(255, 245, 230, 1.0);
                g.setStrokeColor(120, 90, 40, 1.0);
            } else {
                g.setFillColor(235, 235, 235, 1.0);
                g.setStrokeColor(60, 60, 60, 1.0);
            }
            g.fillRect(x, y, w, h);
            g.drawRect(x, y, w, h);
            g.drawText(id, x + 8, y + 20);
        }

        // Draw edges with simple orthogonal routing
        g.setStrokeColor(60, 60, 60, 1.0);
        g.setLineWidth(1.0);
        for (Relationship rel : data.relationships) {
            Point2D p1 = layout.getPosition(rel.getFromId());
            Point2D p2 = layout.getPosition(rel.getToId());
            if (p1 == null || p2 == null) continue;

            double w1 = metrics.getWidth(rel.getFromId()) * zoom;
            double h1 = metrics.getHeight(rel.getFromId()) * zoom;
            double w2 = metrics.getWidth(rel.getToId()) * zoom;
            double h2 = metrics.getHeight(rel.getToId()) * zoom;

            double x1 = p1.getX() * zoom + panX + w1 / 2.0;
            double y1 = p1.getY() * zoom + panY + h1 / 2.0;
            double x2 = p2.getX() * zoom + panX + w2 / 2.0;
            double y2 = p2.getY() * zoom + panY + h2 / 2.0;

            double midX = (x1 + x2) / 2.0;
            g.drawLine(x1, y1, midX, y1);
            g.drawLine(midX, y1, midX, y2);
            g.drawLine(midX, y2, x2, y2);
        }
    }
}
