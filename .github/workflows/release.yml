name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Create Release Keystore
        run: |
          keytool -genkey -v -keystore app-android/release.keystore \
            -alias release \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=Family Tree Editor, OU=Development, O=Family Tree, L=Unknown, ST=Unknown, C=US"
      
      - name: Build Android Release APK
        run: ./gradlew :app-android:assembleRelease
      
      - name: Verify APK Signature
        run: |
          APKSIGNER=$(find $ANDROID_HOME/build-tools -name "apksigner.jar" | sort -r | head -n 1)
          echo "Using apksigner: $APKSIGNER"
          java -jar "$APKSIGNER" verify --print-certs app-android/build/outputs/apk/release/app-android-release.apk
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: app-android/build/outputs/apk/release/*.apk

  build-desktop:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            task: packageDeb
            suffix: linux
          - os: macos-latest
            task: packageDmg
            suffix: mac
          - os: windows-latest
            task: packageMsi
            suffix: windows
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew
      
      - name: Package Desktop
        run: ./gradlew :app-desktop:${{ matrix.task }}
        shell: bash

      - name: List Desktop Build Output
        run: find app-desktop/build/compose/binaries -maxdepth 4
        continue-on-error: true
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.suffix }}
          path: app-desktop/build/compose/binaries/main/*/*

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Set correct JAVA_HOME for Xcode
        run: |
          JAVA_HOME_PATH=$(/usr/libexec/java_home -v 21)
          echo "JAVA_HOME=$JAVA_HOME_PATH" >> $GITHUB_ENV
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build iOS App (Archive)
        working-directory: iosApp
        run: |
          xcodebuild -project iosApp.xcodeproj \
            -scheme iosApp \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build \
            archive \
            -archivePath build/iosApp.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Zip Archive
        run: |
          if [ -d "iosApp/build/iosApp.xcarchive" ]; then
            zip -r ios-app-archive.zip iosApp/build/iosApp.xcarchive
          else
            echo "Archive not found, skipping zip"
          fi
      
      - name: Upload Artifact
        if: hashFiles('ios-app-archive.zip') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: ios-app-archive.zip

  publish-release:
    needs: [build-android, build-desktop, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/android-release/*.apk
            artifacts/desktop-linux/*.deb
            artifacts/desktop-mac/*.dmg
            artifacts/desktop-windows/*.msi
            artifacts/ios-archive/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
